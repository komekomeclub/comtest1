<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Compass Map [ver4]</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º */
        #version-label {
            position: fixed; top: 20px; left: 20px;
            font-size: 24px; font-weight: bold; color: red;
            background-color: rgba(255,255,255,0.9);
            padding: 5px 10px; border: 2px solid red;
            z-index: 2000; pointer-events: none;
        }

        /* ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ */
        #compass-btn {
            position: fixed; left: 20px; top: 50%;
            transform: translateY(-50%);
            width: 60px; height: 60px;
            background-color: white; border: 2px solid #ccc;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 1000; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; outline: none; user-select: none;
            -webkit-tap-highlight-color: transparent; transition: all 0.3s;
        }
        #compass-btn.active {
            background-color: orange; border-color: #d35400; color: white;
            box-shadow: 0 0 15px orange;
        }

        /* æ–¹è§’ã®æ•°å€¤ã‚’ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆç¢ºèªç”¨ï¼‰ */
        #debug-info {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.7); color: white;
            padding: 5px; font-size: 12px; z-index: 2000;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="version-label">[ver4]</div>
    <div id="debug-info">Angle: ---</div>
    <button id="compass-btn">ğŸ§­</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- è¨­å®š ---
        // æ—¥æœ¬ã®åè§’è£œæ­£ï¼ˆè¥¿åç´„7åº¦ï¼‰ã€‚
        // ç£åŒ—(Magnetic North)ã¯çœŸåŒ—(True North)ã‚ˆã‚Šè¥¿ã«ãšã‚Œã¦ã„ã‚‹ãŸã‚ã€
        // åœ°å›³ä¸Šã®åŒ—(0)ã«åˆã‚ã›ã‚‹ã«ã¯ãƒã‚¤ãƒŠã‚¹è£œæ­£ã‚’è¡Œã„ã¾ã™ã€‚
        const DECLINATION_CORRECTION = -7; 

        // --- 1. åœ°å›³åˆæœŸåŒ– ---
        const map = L.map('map').setView([35.681236, 139.767125], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let currentLat = null;
        let currentLng = null;
        let currentMarker = null;
        let directionLine = null;
        let isCompassActive = false;
        let lastHeading = 0;

        // --- 2. GPSå‡¦ç† ---
        function onLocationFound(e) {
            currentLat = e.coords.latitude;
            currentLng = e.coords.longitude;
            
            if (!currentMarker) {
                currentMarker = L.circleMarker([currentLat, currentLng], {
                    color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 10
                }).addTo(map);
                map.setView([currentLat, currentLng], 16);
            } else {
                currentMarker.setLatLng([currentLat, currentLng]);
            }
            if (isCompassActive) drawCompassLine(lastHeading);
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(onLocationFound, null, { enableHighAccuracy: true });
        }

        // --- 3. ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ ---
        const btn = document.getElementById('compass-btn');
        const debugInfo = document.getElementById('debug-info');

        btn.addEventListener('click', async () => {
            // iOS Permission
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') { alert('è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ'); return; }
                } catch (e) { console.error(e); }
            }

            isCompassActive = !isCompassActive;

            if (isCompassActive) {
                btn.classList.add('active');
                
                // Androidç”¨ï¼šçµ¶å¯¾å€¤ã‚¤ãƒ™ãƒ³ãƒˆ(deviceorientationabsolute)ãŒä½¿ãˆã‚‹ã‹ç¢ºèª
                if ('ondeviceorientationabsolute' in window) {
                    window.addEventListener('deviceorientationabsolute', handleOrientation);
                } else {
                    // iOSã¾ãŸã¯å¤ã„Android
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            } else {
                btn.classList.remove('active');
                if ('ondeviceorientationabsolute' in window) {
                    window.removeEventListener('deviceorientationabsolute', handleOrientation);
                } else {
                    window.removeEventListener('deviceorientation', handleOrientation);
                }
                if (directionLine) {
                    map.removeLayer(directionLine);
                    directionLine = null;
                }
                debugInfo.innerText = "Angle: ---";
            }
        });

        // --- 4. æ–¹è§’è¨ˆç®—å‡¦ç†ï¼ˆé‡è¦ï¼‰ ---
        function handleOrientation(event) {
            let heading = 0;

            if (event.webkitCompassHeading) {
                // iOS: ã“ã‚ŒãŒä¸€ç•ªæ­£ç¢ºï¼ˆç£åŒ—ï¼‰
                heading = event.webkitCompassHeading;
            } else if (event.absolute === true || event.alpha !== null) {
                // Android (absolute):
                // alphaã¯åæ™‚è¨ˆå›ã‚Š(0=åŒ—, 90=è¥¿, 180=å—, 270=æ±)ã®ã“ã¨ãŒå¤šã„
                // åœ°å›³ç”¨(æ™‚è¨ˆå›ã‚Š)ã«å¤‰æ›: 360 - alpha
                heading = 360 - event.alpha;
            }

            // åè§’è£œæ­£ã‚’åŠ ãˆã‚‹
            heading += DECLINATION_CORRECTION;

            // 0-360ã®ç¯„å›²ã«åã‚ã‚‹
            if (heading < 0) heading += 360;
            if (heading >= 360) heading -= 360;

            lastHeading = heading;
            
            // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆç”»é¢å·¦ä¸‹ï¼‰
            debugInfo.innerText = `Angle: ${Math.round(heading)}Â°`;
            
            drawCompassLine(heading);
        }

        function drawCompassLine(heading) {
            if (currentLat === null || currentLng === null) return;
            
            const lengthKm = 3; // ç·šã‚’å°‘ã—çŸ­ã(3km)
            
            // åŒ—(0åº¦)åŸºæº–ã§æ™‚è¨ˆå›ã‚Šã®è§’åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«
            const headingRad = heading * (Math.PI / 180);

            // ç·¯åº¦çµŒåº¦ã®ç§»å‹•é‡ã‚’è¨ˆç®—
            const dy = (lengthKm / 111) * Math.cos(headingRad);
            const dx = (lengthKm / (111 * Math.cos(currentLat * Math.PI / 180))) * Math.sin(headingRad);

            const latlngs = [
                [currentLat, currentLng],
                [currentLat + dy, currentLng + dx]
            ];

            if (directionLine) map.removeLayer(directionLine);

            directionLine = L.polyline(latlngs, {
                color: 'orange', weight: 5, opacity: 0.7
            }).addTo(map);
        }
    </script>
</body>
</html>
