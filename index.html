<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Compass Map App</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        
        /* åœ°å›³ã‚’å…¨ç”»é¢è¡¨ç¤º */
        #map {
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* å·¦ç«¯ã®ä¸¸ã„ãƒœã‚¿ãƒ³ */
        #compass-btn {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 1000; /* åœ°å›³ã‚ˆã‚Šæ‰‹å‰ã« */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            outline: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ãƒœã‚¿ãƒ³ãŒONã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #compass-btn.active {
            background-color: orange;
            border-color: #d35400;
            color: white;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <button id="compass-btn">ğŸ§­</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. åœ°å›³ã®åˆæœŸåŒ– ---
        const map = L.map('map').setView([35.6895, 139.6917], 15); // åˆæœŸä½ç½®ï¼ˆã¨ã‚Šã‚ãˆãšæ±äº¬ï¼‰

        // OpenStreetMapã®èª­ã¿è¾¼ã¿
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- å¤‰æ•°å®šç¾© ---
        let currentLat = null;
        let currentLng = null;
        let currentMarker = null;   // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
        let directionLine = null;   // ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®ç·š
        let isCompassActive = false; // æ©Ÿèƒ½ON/OFFãƒ•ãƒ©ã‚°
        const lineLengthKm = 5;     // ç·šã®é•·ã•ï¼ˆç´„5kmï¼‰

        // --- 2. ç¾åœ¨åœ°ã®å–å¾—ã¨è¡¨ç¤º ---
        // GPSã®ç›£è¦–ã‚’é–‹å§‹
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // åˆå›ã¾ãŸã¯ç§»å‹•æ™‚ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
                    if (!currentMarker) {
                        // ç¾åœ¨åœ°ã‚’é’ã„ä¸¸ã§è¡¨ç¤º
                        currentMarker = L.circleMarker([currentLat, currentLng], {
                            color: 'blue',
                            fillColor: '#30f',
                            fillOpacity: 0.5,
                            radius: 10
                        }).addTo(map);
                        map.setView([currentLat, currentLng], 17); // ç¾åœ¨åœ°ã«ã‚ºãƒ¼ãƒ 
                    } else {
                        currentMarker.setLatLng([currentLat, currentLng]);
                    }

                    // ã‚³ãƒ³ãƒ‘ã‚¹ãŒONãªã‚‰ç·šã‚‚æ›¸ãç›´ã™ï¼ˆæ­©ã„ã¦ç§»å‹•ã—ãŸå ´åˆãªã©ï¼‰
                    if (isCompassActive) {
                        updateLine();
                    }
                },
                (error) => {
                    console.error("GPS Error:", error);
                    alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                },
                {
                    enableHighAccuracy: true, // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        }

        // --- 3. ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã®å‡¦ç† ---
        const btn = document.getElementById('compass-btn');
        let deviceOrientationHandler = null; // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ä¿æŒç”¨
        let currentHeading = 0; // æœ€æ–°ã®æ–¹è§’

        btn.addEventListener('click', async () => {
            // iOS 13+ ã®ãŸã‚ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦æ±‚
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') {
                        alert('ã‚³ãƒ³ãƒ‘ã‚¹ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                        return;
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            // ON/OFF åˆ‡ã‚Šæ›¿ãˆ
            isCompassActive = !isCompassActive;

            if (isCompassActive) {
                // ONã«ãªã£ãŸæ™‚
                btn.classList.add('active');
                window.addEventListener('deviceorientation', handleOrientation);
            } else {
                // OFFã«ãªã£ãŸæ™‚
                btn.classList.remove('active');
                window.removeEventListener('deviceorientation', handleOrientation);
                removeLine(); // ç·šã‚’æ¶ˆã™
            }
        });

        // --- 4. ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ï¼ˆæ–¹è§’ï¼‰ã®å‡¦ç† ---
        function handleOrientation(event) {
            let heading = 0;

            // iOS (webkitCompassHeading) ã¨ Android (alpha) ã®é•ã„ã‚’å¸å
            if (event.webkitCompassHeading) {
                // iOS
                heading = event.webkitCompassHeading;
            } else if (event.alpha) {
                // Android (absoluteãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆãªã©)
                // alphaã¯åæ™‚è¨ˆå›ã‚Šãªã®ã§è£œæ­£ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ãŒã€
                // ä¸€èˆ¬çš„ãªãƒ–ãƒ©ã‚¦ã‚¶å®Ÿè£…ã§ã¯ 360 - alpha ãŒåŒ—åŸºæº–ã«ãªã‚‹ã“ã¨ãŒå¤šã„ã§ã™
                heading = 360 - event.alpha; 
            }

            currentHeading = heading;
            updateLine();
        }

        // --- 5. ç·šã®æç”»å‡¦ç† ---
        function updateLine() {
            if (!isCompassActive || currentLat === null || currentLng === null) return;

            // ç¾åœ¨åœ°ã‹ã‚‰ currentHeading ã®æ–¹å‘ã«ç·šã‚’è¨ˆç®—
            // ç°¡æ˜“è¨ˆç®—: ç·¯åº¦1åº¦â‰’111km, çµŒåº¦1åº¦â‰’111km * cos(lat)
            // ãƒ©ã‚¸ã‚¢ãƒ³å¤‰æ›
            // åœ°å›³ä¸Šã®è§’åº¦ï¼ˆåŒ—=0, æ™‚è¨ˆå›ã‚Šï¼‰ã«åˆã‚ã›ã¦è¨ˆç®—
            const rad = (currentHeading - 90) * (Math.PI / 180); 
            // â€» æ•°å­¦åº§æ¨™ç³»ã§ã¯0åº¦ãŒæ±ãªã®ã§ -90åº¦ã—ã¦è£œæ­£...ã¨ã„ããŸã„ã¨ã“ã‚ã§ã™ãŒã€
            // åœ°å›³è¨ˆç®—ã§ã¯ åŒ—(0) ã‚’åŸºæº–ã«è¨ˆç®—ã—ã¾ã™ã€‚
            
            // åŒ—ã‚’0åº¦ã¨ã—ã¦æ™‚è¨ˆå›ã‚Š
            const headingRad = currentHeading * (Math.PI / 180);

            // ç·šã®çµ‚ç‚¹ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“çš„ãªå¹³é¢è¿‘ä¼¼ï¼‰
            // km ã‚’ ç·¯åº¦çµŒåº¦å·®åˆ†ã«å¤‰æ› (1åº¦ ç´„111km)
            const distDeg = lineLengthKm / 111; 
            
            const dLat = distDeg * Math.cos(headingRad); 
            const dLng = distDeg * Math.sin(headingRad) / Math.cos(currentLat * Math.PI / 180);

            const endLat = currentLat + dLat;
            const endLng = currentLng + dLng;

            const latlngs = [
                [currentLat, currentLng],
                [endLat, endLng]
            ];

            // æ—¢å­˜ã®ç·šãŒã‚ã‚Œã°å‰Šé™¤ã—ã¦æ›¸ãç›´ã™
            if (directionLine) {
                map.removeLayer(directionLine);
            }

            // ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®ç·šã‚’æç”»
            directionLine = L.polyline(latlngs, {
                color: 'orange',
                weight: 5,
                opacity: 0.8
            }).addTo(map);
        }

        function removeLine() {
            if (directionLine) {
                map.removeLayer(directionLine);
                directionLine = null;
            }
        }
    </script>
</body>
</html>
